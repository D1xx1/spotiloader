{% extends "base.html" %}
{% block content %}
<!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ -->
<div class="card" style="margin-bottom:14px;">
    <form method="get" action="{% url 'search' %}">
        <div class="row" style="gap:10px;">
            <input 
                type="text" 
                name="q" 
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Linkin Park - Numb –ò–õ–ò https://open.spotify.com/track/‚Ä¶"
                class="input"
                style="flex:1; padding:8px 12px; border:1px solid var(--border); border-radius:6px; background:var(--surface); color:var(--ink); font-size:14px;"
            >
            <button class="btn" type="submit" style="padding:8px 16px; background:var(--accent); color:white; border:none; border-radius:6px; cursor:pointer; font-size:14px;">–ò—Å–∫–∞—Ç—å</button>
        </div>
    </form>
</div>

<div class="grid cols-2">
    <div class="card">
        <div class="row">
            <img class="thumb" style="width:96px;height:96px;" src="{{ meta.image }}" alt="">
            <div>
                <h2 style="margin:0 0 6px 0;">{{ meta.name }}</h2>
                <div class="muted">{{ meta.artists }}</div>
                <div class="muted">–ê–ª—å–±–æ–º: {{ meta.album }}{% if meta.release_date %} ¬∑ {{ meta.release_date }}{% endif %}</div>
                <div class="muted">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {{ meta.duration_str }}{% if meta.popularity %} ¬∑ –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å: {{ meta.popularity }}{% endif %}</div>
                {% if meta.explicit %}<div class="pill" title="Explicit">Explicit</div>{% endif %}
            </div>
        </div>
        <div style="margin-top:12px;">
            <a class="pill" href="{{ meta.external_url }}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å –≤ Spotify</a>
            {% if meta.preview_url %}
                <div class="preview-player">
                    <div class="preview-header">
                        <span class="preview-icon">üéµ</span>
                        <span class="preview-title">–ü—Ä–µ–≤—å—é —Ç—Ä–µ–∫–∞ (30 —Å–µ–∫)</span>
                    </div>
                    <audio 
                        id="preview-audio"
                        class="preview-audio" 
                        controls 
                        preload="metadata"
                        src="{{ meta.preview_url }}"
                        style="width:100%; margin-top:8px; border-radius:8px;"
                    ></audio>
                    <div class="preview-info">
                        <small class="muted">–ü—Ä–µ–≤—å—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ Spotify</small>
                        <div class="preview-status" id="preview-status"></div>
                    </div>
                </div>
            {% else %}
                <div class="preview-unavailable">
                    <div class="preview-header">
                        <span class="preview-icon">üîá</span>
                        <span class="preview-title">–ü—Ä–µ–≤—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</span>
                    </div>
                    <div class="preview-info">
                        <small class="muted">–î–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –ø—Ä–µ–≤—å—é</small>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="card">
        <h3 style="margin-top:0;">YouTube —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h3>
        <div class="muted" style="margin-bottom:10px;">–ó–∞–ø—Ä–æ—Å: <strong>{{ yt_query }}</strong></div>
        {% if yt_results %}
            <div class="grid cols-2">
                {% for v in yt_results %}
                    <div class="yt-card">
                        <a href="{{ v.url }}" target="_blank" rel="noopener">
                            <img class="yt-thumb" src="{{ v.thumbnail }}" alt="">
                        </a>

                        <div style="margin-top:6px;">
                            <a href="{{ v.url }}" target="_blank" rel="noopener">{{ v.title }}</a>
                        </div>
                        <div class="muted">{{ v.channel }}</div>
                        <div class="muted" style="font-size:12px;">{{ v.published_at|slice:":10" }}</div>

                        <!-- –ö–ù–û–ü–ö–ê –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –ê–£–î–ò–û -->
                        <div style="margin-top:6px;">
                            <a class="pill download-btn"
                            href="{% url 'youtube_audio' v.video_id %}"
                            download="{{ v.title|slice:':50' }}.mp3"
                            title="–°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ–¥–æ—Ä–æ–∂–∫—É"
                            data-video-id="{{ v.video_id }}">
                                <span class="download-text">–°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ</span>
                                <div class="download-progress" style="display: none;">
                                    <div class="progress-fill"></div>
                                    <span class="progress-text">0%</span>
                                </div>
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ YouTube –∏–ª–∏ –¥–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.</div>
        {% endif %}
    </div>
</div>

<style>
.preview-player {
    background: linear-gradient(135deg, #1a1f3a 0%, #2a2f4a 100%);
    border: 1px solid #3a3f5a;
    border-radius: 12px;
    padding: 16px;
    margin-top: 12px;
}

.preview-unavailable {
    background: linear-gradient(135deg, #2a1f1f 0%, #3a2f2f 100%);
    border: 1px solid #4a3f3f;
    border-radius: 12px;
    padding: 16px;
    margin-top: 12px;
}

.preview-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.preview-icon {
    font-size: 16px;
}

.preview-title {
    font-weight: 600;
    color: var(--ink);
}

.preview-info {
    margin-top: 8px;
    text-align: center;
}

.preview-status {
    margin-top: 4px;
    font-size: 11px;
    color: var(--accent);
}

.preview-audio {
    background: #0e1530;
    border: 1px solid #2a3355;
}

.preview-audio::-webkit-media-controls-panel {
    background: #0e1530;
}

.preview-audio::-webkit-media-controls-play-button {
    background: var(--accent);
    border-radius: 50%;
}

.preview-audio::-webkit-media-controls-current-time-display,
.preview-audio::-webkit-media-controls-time-remaining-display {
    color: var(--ink);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è */
.download-btn {
    position: relative;
    min-width: 120px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.download-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.download-btn.downloading {
    background: linear-gradient(135deg, #1a2f4a 0%, #0f1f3a 100%);
    pointer-events: none;
}

.download-progress {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    z-index: 1;
}

.progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #1DB954, #1ed760);
    transition: width 0.1s ease-out;
    width: 0%;
    z-index: -1;
}

.progress-text {
    font-size: 11px;
    font-weight: 600;
    color: #fff;
    z-index: 2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
}

.download-text {
    transition: opacity 0.3s ease;
    position: relative;
    z-index: 2;
}

.downloading .download-text {
    opacity: 0;
}

.downloading .download-progress {
    display: flex !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const audio = document.getElementById('preview-audio');
    const status = document.getElementById('preview-status');
    
    if (audio && status) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        audio.addEventListener('loadstart', function() {
            status.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–≤—å—é...';
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é
        audio.addEventListener('canplay', function() {
            status.textContent = '–ì–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é';
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
        audio.addEventListener('play', function() {
            status.textContent = '–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...';
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –ø–∞—É–∑–µ
        audio.addEventListener('pause', function() {
            status.textContent = '–ù–∞ –ø–∞—É–∑–µ';
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ–∫–æ–Ω—á–∞–Ω–∏–∏
        audio.addEventListener('ended', function() {
            status.textContent = '–ü—Ä–µ–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ';
        });
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        audio.addEventListener('error', function() {
            status.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é';
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        audio.addEventListener('timeupdate', function() {
            if (audio.currentTime >= 30) {
                audio.pause();
                audio.currentTime = 0;
                status.textContent = '–ü—Ä–µ–≤—å—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ (30 —Å–µ–∫)';
            }
        });
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°–∫–∞—á–∞—Ç—å –∞—É–¥–∏–æ"
    const downloadButtons = document.querySelectorAll('a[href*="/youtube/"][href*="/audio/"]');
    downloadButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const url = button.href;
            const filename = button.getAttribute('download') || 'audio.mp3';
            const videoId = button.getAttribute('data-video-id');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            button.classList.add('downloading');
            const progressFill = button.querySelector('.progress-fill');
            const progressText = button.querySelector('.progress-text');
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SSE –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const eventSource = new EventSource(`/youtube/${videoId}/progress/`);
            
            eventSource.onmessage = function(event) {
                const progress = JSON.parse(event.data);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                progressFill.style.width = progress.progress + '%';
                progressText.textContent = progress.progress + '%';
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                if (progress.status === 'completed') {
                    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                    setTimeout(() => {
                        button.classList.remove('downloading');
                        progressFill.style.width = '0%';
                        progressText.textContent = '0%';
                        eventSource.close();
                    }, 1000);
                } else if (progress.status === 'error') {
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                    console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', progress.message);
                    button.classList.remove('downloading');
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                    eventSource.close();
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + progress.message);
                }
                // –î–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ 'starting', 'downloading', 'processing' - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            };
            
            eventSource.onerror = function() {
                console.error('–û—à–∏–±–∫–∞ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                if (progressText.textContent === '100%') {
                    // –ü—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                    eventSource.close();
                    return;
                }
                
                button.classList.remove('downloading');
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
                eventSource.close();
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            };
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ —Ñ–æ–Ω–µ
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
                    button.classList.remove('downloading');
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                    eventSource.close();
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞');
                });
        });
    });
});
</script>
{% endblock %}